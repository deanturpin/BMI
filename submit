#!/bin/bash

# Send all stderr to stdout
exec 2>&1

# Print MIME type (and an extra blank line)
cat <<MIME
Content-Type: text/plain

MIME

# Check params
[[ $QUERY_STRING == '' ]] && echo Error: no query && exit

readonly mass=$QUERY_STRING

# Database
db=weights.csv

# Today's date
date=$(date +%Y/%m/%d)

# Check if we've already submitted one today
if [[ $(grep $date $db) ]]; then
	echo Error: already submitted today
else
	echo -e "$date,\t$mass" >> $db
	tail $db

	# Print stats
	runghc bmi.hs $mass
fi
